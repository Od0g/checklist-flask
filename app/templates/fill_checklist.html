{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1>{{ template.title }}</h1>
        <h5 class="text-muted">{{ template.sector.name }}</h5>
    </div>
    <div class="card-body">
        <form id="checklistForm" method="POST" action="" enctype="multipart/form-data">
            <input type="hidden" name="signature" id="signature_data">
            
            {% for item in template.items %}
            <div class="mb-4 p-3 border rounded">
                <p class="fw-bold">{{ loop.index }}. {{ item.question }}</p>
                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="item_{{ item.id }}_response" id="item_{{ item.id }}_sim" value="Sim" required>
                        <label class="form-check-label" for="item_{{ item.id }}_sim">Sim</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="item_{{ item.id }}_response" id="item_{{ item.id }}_nao" value="Não">
                        <label class="form-check-label" for="item_{{ item.id }}_nao">Não</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="item_{{ item.id }}_response" id="item_{{ item.id }}_parcial" value="Parcial">
                        <label class="form-check-label" for="item_{{ item.id }}_parcial">Parcial</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="item_{{ item.id }}_response" id="item_{{ item.id }}_nsp" value="NSP">
                        <label class="form-check-label" for="item_{{ item.id }}_nsp">NSP</label>
                    </div>
                </div>
                <div class="form-floating">
                    <textarea class="form-control" placeholder="Adicionar comentário" name="item_{{ item.id }}_comment" style="height: 70px"></textarea>
                    <label>Comentário (opcional)</label>
                </div>
                <div class="mt-2">
                    <label for="item_{{ item.id }}_photo" class="form-label small">Anexar evidência (opcional):</label>
                    <input class="form-control form-control-sm" type="file" name="item_{{ item.id }}_photo" id="item_{{ item.id }}_photo" accept="image/*">
                </div>
            </div>
            {% endfor %}

            <div class="mt-4 p-3 border rounded">
                <label class="form-label fw-bold">Assinatura do Operador:</label>
                <div class="canvas-container bg-light border">
                    <canvas id="signature-pad" style="width: 100%; height: 200px;"></canvas>
                </div>
                <button type="button" id="clear-signature" class="btn btn-sm btn-secondary mt-2">Limpar</button>
            </div>

            <hr>
            <button type="submit" class="btn btn-primary btn-lg mt-3">Enviar Checklist</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/signature_pad.umd.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // Encontra o canvas com o ID 'signature-pad'
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(248, 249, 250)'
        });

        // Encontra o botão de limpar com o ID 'clear-signature'
        document.getElementById('clear-signature').addEventListener('click', function () {
            signaturePad.clear();
        });

        // Encontra o formulário com o ID 'checklistForm'
        document.getElementById('checklistForm').addEventListener('submit', function (e) {
            if (signaturePad.isEmpty()) {
                alert("Por favor, forneça sua assinatura.");
                e.preventDefault();
            } else {
                // Coloca os dados da assinatura no campo oculto com ID 'signature_data'
                document.getElementById('signature_data').value = signaturePad.toDataURL('image/png');
            }
        });
    });
</script>
{% endblock %}
